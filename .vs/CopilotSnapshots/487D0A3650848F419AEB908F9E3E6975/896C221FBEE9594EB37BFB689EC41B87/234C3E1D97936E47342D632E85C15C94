// wwwroot/kaj-audio-particles.js
// Audio-reactive particle effect for Blazor KajWallpaper

let audioContext, analyser, sourceNode, dataArray, animationId;
let particleCanvas, ctx, particles = [];

function createParticles(count) {
    particles = [];
    for (let i = 0; i < count; i++) {
        particles.push({
            x: Math.random() * particleCanvas.width,
            y: Math.random() * particleCanvas.height,
            r: 2 + Math.random() * 3,
            dx: (Math.random() - 0.5) * 1.5,
            dy: (Math.random() - 0.5) * 1.5,
            color: `hsl(${Math.random()*360}, 80%, 60%)`
        });
    }
}

function drawParticles(volume) {
    ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
    for (let p of particles) {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r + volume * 0.2, 0, 2 * Math.PI);
        ctx.fillStyle = p.color;
        ctx.globalAlpha = 0.5 + volume * 0.5;
        ctx.fill();
        ctx.globalAlpha = 1;
        p.x += p.dx + (Math.random()-0.5)*volume*0.2;
        p.y += p.dy + (Math.random()-0.5)*volume*0.2;
        if (p.x < 0 || p.x > particleCanvas.width) p.dx *= -1;
        if (p.y < 0 || p.y > particleCanvas.height) p.dy *= -1;
    }
}

function animateParticles() {
    if (!analyser) return;
    analyser.getByteFrequencyData(dataArray);
    let volume = 0;
    for (let i = 0; i < dataArray.length; i++) volume += dataArray[i];
    volume = volume / dataArray.length / 255;
    drawParticles(volume);
    animationId = requestAnimationFrame(animateParticles);
}

export async function startAudioParticles(audioSelector, canvasSelector) {
    particleCanvas = document.querySelector(canvasSelector);
    if (!particleCanvas) return;
    ctx = particleCanvas.getContext('2d');
    createParticles(48);
    let audio = document.querySelector(audioSelector);
    if (!audio) return;
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (!sourceNode) sourceNode = audioContext.createMediaElementSource(audio);
    if (!analyser) analyser = audioContext.createAnalyser();
    analyser.fftSize = 64;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    sourceNode.connect(analyser);
    analyser.connect(audioContext.destination);
    animateParticles();
}

export function stopAudioParticles() {
    if (animationId) cancelAnimationFrame(animationId);
    if (ctx && particleCanvas) ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
}
